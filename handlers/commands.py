import logging
from aiogram import Router, types, Bot
from aiogram.filters import Command, ChatMemberUpdatedFilter
from aiogram.types import ChatMemberUpdated, Message, BotCommand
from aiogram.enums import ChatMemberStatus, ParseMode
from config import BOT_USERNAME, GROUP_WELCOME_MESSAGE
from utils.logger import logger

router = Router()

active_chats = set()

async def setup_bot_commands(bot: Bot):
    commands = [
        BotCommand(command="start", description="ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°"),
        BotCommand(command="help", description="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ"),
        BotCommand(command="stop", description="Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°")
    ]
    await bot.set_my_commands(commands)
    logger.info("ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹")

@router.message(Command(commands=["start"]))
async def send_welcome(message: Message):
    user_id = message.from_user.id
    chat_id = message.chat.id
    
    active_chats.add(chat_id)
    
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")
    
    welcome_text = [
        f"ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {message.from_user.full_name}! ğŸ‘‹",
        f"Ğ¯ - {BOT_USERNAME}, Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¼ĞµĞ´Ğ¸Ğ°.",
        "",
        "ğŸ“‹ **Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:**",
        "/start - Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ",
        "/help - Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ÑƒÑ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ", 
        "/stop - Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ",
        "",
        "ğŸ“¸ **ĞšĞ°Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ:**",
        "1. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¼Ğ½Ğµ Ñ„Ğ¾Ñ‚Ğ¾, Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ¸Ğ»Ğ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ",
        "2. Ğ¯ Ğ¾Ğ¿Ğ¸ÑˆÑƒ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¸Ğ»Ğ¸ ÑĞ´ĞµĞ»Ğ°Ñ Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ¿Ñ†Ğ¸Ñ",
        "",
        "ğŸ’¡ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /help Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸!"
    ]
    
    await message.answer("\n".join(welcome_text), parse_mode=ParseMode.MARKDOWN)

@router.message(Command(commands=["stop"]))
async def send_goodbye(message: Message):
    user_id = message.from_user.id
    chat_id = message.chat.id
    
    active_chats.discard(chat_id)
    
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {chat_id}")
    
    goodbye_text = [
        "ğŸ›‘ **A-Vision Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½**",
        "",
        "Ğ‘Ğ¾Ñ‚ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ´Ğ¸Ğ° Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ.",
        "",
        "ğŸ’¡ Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start"
    ]
    
    await message.answer("\n".join(goodbye_text), parse_mode=ParseMode.MARKDOWN)

@router.message(Command(commands=["help"]))
async def cmd_help(message: types.Message):
    try:
        help_text = [
            f"ğŸ¤– {BOT_USERNAME} - Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¼ĞµĞ´Ğ¸Ğ°",
            "\nĞ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:",
            "/start - Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ",
            "/stop - Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğµ",
            "/help - Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ",
            "Ğ”Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ¸ **Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°.**"
            "\nĞšĞ°Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ:",
            "1. ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞ¹ Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start",
            "2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ Ğ»ÑĞ±Ğ¾Ğ¹ Ğ¼ĞµĞ´Ğ¸Ğ°-Ñ„Ğ°Ğ¹Ğ» (Ñ„Ğ¾Ñ‚Ğ¾, Ğ²Ğ¸Ğ´ĞµĞ¾, Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ)",
            "3. Ğ‘Ğ¾Ñ‚ Ğ¾Ğ¿Ğ¸ÑˆĞµÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°, Ğ»Ğ¸Ğ±Ğ¾ ÑĞ´ĞµĞ»Ğ°ĞµÑ‚ Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ¿Ñ†Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.\n\n",
            "[Its mine, but it can be yours](https://github.com/aspect-cloud/a_vision)"
        ]
        
        await message.answer("\n".join(help_text), parse_mode=ParseMode.MARKDOWN)
        
        logger.info(f"ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑˆĞµĞ½Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {message.from_user.id}")
        
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸ Ğ² Ñ‡Ğ°Ñ‚Ğµ {message.chat.id}: {e}")
        await message.answer("ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ° Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")

@router.my_chat_member()
async def on_bot_promote(event: ChatMemberUpdated, bot: Bot):
    logger.info(
        f"Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ğ² Ñ‡Ğ°Ñ‚Ğµ {event.chat.id}. "
        f"Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: {event.old_chat_member.status.value}, "
        f"ĞĞ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: {event.new_chat_member.status.value}"
    )

    if event.new_chat_member.status == ChatMemberStatus.ADMINISTRATOR and event.new_chat_member.user.id == bot.id:
        try:
            await bot.send_message(event.chat.id, GROUP_WELCOME_MESSAGE, parse_mode="Markdown")
            logger.info(f"Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞµĞ½ Ğ´Ğ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {event.chat.id}")
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞµĞ½Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ² Ñ‡Ğ°Ñ‚Ğµ {event.chat.id}: {e}")

def is_chat_active(chat_id: int) -> bool:
    return chat_id in active_chats